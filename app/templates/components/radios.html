{% from "components/select-input.html" import select, select_list, select_nested, select_wrapper, select_input %}
{% from "components/error-message/macro.njk" import govukErrorMessage -%}
{% from "components/fieldset/macro.njk" import govukFieldset %}
{% from "components/hint/macro.njk" import govukHint %}
{% from "components/label/macro.njk" import govukLabel %}

{% macro radios(field, hint=None, disable=[], option_hints={}, hide_legend=False, inline=False) %}
  {{ select(field, hint, disable, option_hints, hide_legend, input="radio", inline=inline) }}
{% endmacro %}


{% macro radio_list(options, child_map, disable=[], option_hints={}) %}
  {{ select_list(options, child_map, disable, option_hints, input="radio") }}
{% endmacro %}


{% macro radios_nested(field, child_map, hint=None, disable=[], option_hints={}, hide_legend=False) %}
  {{ select_nested(field, child_map, hint, disable, option_hints, hide_legend, input="radio") }}
{% endmacro %}


{% macro radio(option, disable=[], option_hints={}, data_target=None, as_list_item=False) %}
  {{ select_input(option, disable, option_hints, data_target, as_list_item, input="radio") }}
{% endmacro %}


{% macro radio_select(
 field,
 hint=None,
 wrapping_class='form-group'
) %}
 <div class="{{ wrapping_class }} {% if field.errors %} form-group-error{% endif %}">
   <fieldset>
     <legend class="form-label">
       {{ field.label.text }}
       {% if field.errors %}
         <span class="error-message" data-module="track-error" data-error-type="{{ field.errors[0] }}" data-error-label="{{ field.name }}">
           {{ field.errors[0] }}
         </span>
       {% endif %}
     </legend>
     <div class="radio-select" data-module="radio-select" data-categories="{{ field.categories|join(',') }}">
       <div class="radio-select-column">
       {% for option in field %}
         <div class="multiple-choice">
           {{ option }}
           <label for="{{ option.id }}">
             {{ option.label.text }}
           </label>
         </div>
         {% if loop.first %}
       </div>
       <div class="radio-select-column">
         {% endif %}
       {% endfor %}
       </div>
     </div>
   </fieldset>
 </div>
{% endmacro %}


{% macro conditional_radio_panel(id) %}
  <div class="conditional-radios-panel js-hidden" id="{{ id }}">
    {{ caller() }}
  </div>
{% endmacro %}


{#- Copied from https://github.com/alphagov/govuk-frontend/blob/v2.13.0/src/components/radios/template.njk
    Changes:
    - `asList` option added the root `params` object to allow setting of the `.govuk-radios` and `.govuk-radios__item` element types
    - Nunjucks-to-Jinja language problems fixed (see https://github.com/alphagov/govuk-frontend-jinja/blob/master/govuk_frontend_jinja/templates.py) -#}
{% macro notifyRadios(params) %}

  {#- If an id 'prefix' is not passed, fall back to using the name attribute
     instead. We need this for error messages and hints as well -#}
  {% set idPrefix = params.idPrefix if params.idPrefix else params.name %}

  {#- a record of other elements that we need to associate with the input using
     aria-describedby â€“ for example hints or error messages -#}
  {% set describedBy = params.fieldset.describedBy if params.fieldset.describedBy else "" %}

  {#- set the types of element used for the checkboxes and their group based on
     whether asList is set -#}
  {% if params.asList %}
    {% set groupElement = 'ul' %}
    {% set groupItemElement = 'li' %}
  {% else %}
    {% set groupElement = 'div' %}
    {% set groupItemElement = 'div' %}
  {% endif %}

  {% set isConditional = False %}
  {% for item in params['items'] %}
    {% if item.conditional %}
      {% set isConditional = True %}
    {% endif %}
  {% endfor %}

  {#- Capture the HTML so we can optionally nest it in a fieldset -#}
  {% set innerHtml %}
  {% if params.hint %}
    {% set hintId = idPrefix ~ '-hint' %}
    {% set describedBy = describedBy ~ ' ' ~ hintId if describedBy else hintId %}
    {{ govukHint({
      "id": hintId,
      "classes": params.hint.classes,
      "attributes": params.hint.attributes,
      "html": params.hint.html,
      "text": params.hint.text
    }) | indent(2) | trim }}
  {% endif %}
  {% if params.errorMessage %}
    {% set errorId = idPrefix ~ '-error' %}
    {% set describedBy = describedBy ~ ' ' ~ errorId if describedBy else errorId %}
    {{ govukErrorMessage({
      "id": errorId,
      "classes": params.errorMessage.classes,
      "attributes": params.errorMessage.attributes,
      "html": params.errorMessage.html,
      "text": params.errorMessage.text,
      "visuallyHiddenText": params.errorMessage.visuallyHiddenText
    }) | indent(2) | trim }}
  {% endif %}
    <{{ groupElement }} class="govuk-radios {%- if params.classes %} {{ params.classes }}{% endif %}{%- if isConditional %} govuk-radios--conditional{% endif -%}"
      {%- for attribute, value in params.attributes %} {{ attribute }}="{{ value }}"{% endfor %}
      {%- if isConditional %} data-module="radios"{% endif -%}>
      {% for item in params['items'] %}
      {% set id = item.id if item.id else idPrefix ~ "-" ~ loop.index %}
      {% set conditionalId = "conditional-" ~ id %}
      {%- if item.divider %}
      <div class="govuk-radios__divider">{{ item.divider }}</div>
      {%- else %}
      {% set hasHint = True if item.hint.text or item.hint.html %}
      {% set itemHintId = id ~ '-item-hint' %}
      <{{ groupItemElement}} class="govuk-radios__item">
        <input class="govuk-radios__input" id="{{ id }}" name="{{ params.name }}" type="radio" value="{{ item.value }}"
        {{-" checked" if item.checked }}
        {{-" disabled" if item.disabled }}
        {%- if item.conditional %} data-aria-controls="{{ conditionalId }}"{% endif -%}
        {%- if hasHint %} aria-describedby="{{ itemHintId }}"{% endif -%}
        {%- for attribute, value in item.attributes %} {{ attribute }}="{{ value }}"{% endfor -%}>
        {{ govukLabel({
          "html": item.html,
          "text": item.text,
          "classes": 'govuk-radios__label' ~ (' ' ~ item.label.classes if item.label.classes),
          "attributes": item.label.attributes,
          "for": id
        }) | indent(6) | trim }}
        {%- if hasHint %}
        {{ govukHint({
          "id": itemHintId,
          "classes": 'govuk-radios__hint',
          "attributes": item.hint.attributes,
          "html": item.hint.html,
          "text": item.hint.text
        }) | indent(6) | trim }}
        {%- endif %}
        {%- if params.asList and item.conditional %}
          <div class="govuk-radios__conditional{% if not item.checked %} govuk-radios__conditional--hidden{% endif %}" id="{{ conditionalId }}">
            {{ item.conditional.html | safe }}
          </div>
        {% endif %}
        {% if item.children %}
          {{ notifyRadios({
            "describedBy": describedBy,
            "idPrefix": params.idPrefix,
            "name": params.name,
            "formGroup": {
              "classes": "govuk-form-group--nested"
            },
            "fieldset": {
              "legend": {
                "text": item.text,
                "classes": "govuk-visually-hidden"
              }
            },
            "asList": True,
            "items": item.children
          }) }}
        {% endif %}
      </{{ groupItemElement }}>
      {%- if not params.asList and item.conditional %}
        <div class="govuk-radios__conditional{% if not item.checked %} govuk-radios__conditional--hidden{% endif %}" id="{{ conditionalId }}">
          {{ item.conditional.html | safe }}
        </div>
      {% endif %}
      {% endif %}
      {% endfor %}
    </{{ groupElement }}>
  {% endset -%}

  <div class="govuk-form-group {%- if params.errorMessage %} govuk-form-group--error{% endif %} {%- if params.formGroup.classes %} {{ params.formGroup.classes }}{% endif %}">
  {% if params.fieldset %}
    {% call govukFieldset({
      "describedBy": describedBy,
      "classes": params.fieldset.classes,
      "attributes": params.fieldset.attributes,
      "legend": params.fieldset.legend
    }) %}
    {{ innerHtml | trim | safe }}
    {% endcall %}
  {% else %}
    {{ innerHtml | trim | safe }}
  {% endif %}
  </div>
{% endmacro %}
