{% from "components/checkbox.html" import notifyCollapsibleCheckboxes %}
{% from "components/radios.html" import radio, radios, conditional_radio_panel %}
{% from "components/checkboxes/macro.njk" import govukCheckboxes %}

{% set items = [] %}
{% for option in form.permissions_fields %}
  {% set _ = items.append({
    "name": option.name,
    "text": option.label.text,
    "value": 'y',
    "checked": option.data
  }) %}
{% endfor %}
{{ govukCheckboxes({
  "idPrefix": "permissions",
  "fieldset": {
    "legend": {
      "text": "Permissions",
      "classes": "govuk-fieldset__legend--s"
    }
  },
  "hint": {
    "text": "All team members can see sent messages."
  },
  "items": items
}) }}

{% macro build_tree_from_fields(_items, _fields) %}
  {% for _field in _fields %}
    {% set _item = {
      "name": _field.name,
      "text": _field.label.text,
      "value": _field.data,
      "checked": _field.checked
    } %}
    {% if _field.data in form.folder_permissions.children() %}
      {% set _ = _item.update({"children": []}) %}
      {{ build_tree_from_fields(_item["children"], form.folder_permissions.children()[_field.data]) }}
    {% endif %}
    {% set _ = _items.append(_item) %}
  {% endfor %}
{% endmacro %}


{% if form.folder_permissions.all_template_folders %}
  {% set folder_permissions = [] %}
  {% set _ =  build_tree_from_fields(folder_permissions, form.folder_permissions.children()[None]) %}
  {{ notifyCollapsibleCheckboxes({
    "idPrefix": "folder_permissions",
    "fieldset": {
      "attributes": { "id": form.folder_permissions.id },
      "legend": {
        "text": "Folders this team member can see",
        "classes": "govuk-fieldset__legend--s"
      }
    },
    "asList": True,
    "items": folder_permissions
  }, 'folder') }}
{% elif user and user.platform_admin %}
  <p class="bottom-gutter">
    Platform admin users can access all template folders.
  </p>
{% endif %}

{% if service_has_email_auth %}
  {% if not mobile_number %}
    {{ radios(
      form.login_authentication,
      disable=['sms_auth'],
      option_hints={'sms_auth': 'Not available because this team member has not added a phone&nbsp;number to their profile'|safe}
    ) }}
  {% else %}
    {{ radios(form.login_authentication) }}
  {% endif %}
{% endif %}
