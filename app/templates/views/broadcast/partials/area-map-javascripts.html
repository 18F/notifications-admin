<link rel="stylesheet" href="https://labs.os.uk/public/os-api-branding/v0.2.0/os-api-branding.css" />
<link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.1/mapbox-gl.css" />
<script src="{{ asset_url('javascripts/leaflet.js') }}"></script>
<!--  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>-->
<script src="https://labs.os.uk/public/os-api-branding/v0.2.0/os-api-branding.js"></script>
<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.1/mapbox-gl.js"></script>
<script src="https://unpkg.com/mapbox-gl-leaflet/leaflet-mapbox-gl.js"></script>

<script>
  var polygons = []

  {% for polygon in broadcast_message.simple_polygons_with_bleed.as_coordinate_pairs_lat_long %}
    polygons.push(
      L.polygon({{polygon}}, {
        opacity: 1,
        color: '#005ea5',
        fillColor: '#2B8CC4',
        fillOpacity: 0.15,
        weight: 2,
        dashArray: [6, 7],
        lineCap: 'butt'
      })
    );
  {% endfor %}

  {% for polygon in broadcast_message.polygons.as_coordinate_pairs_lat_long %}
    polygons.push(
      L.polygon({{polygon}}, {
        color: '#0b0b0c',
        fillColor: '#2B8CC4',
        fillOpacity: 0.3,
        weight: 2
      })
    );
  {% endfor %}

  var serviceUrl = 'https://api.os.uk/maps/vector/v1/vts';
  var apiKey = 'x2pEKrtVsMPF6mfYGt5LJ8F9AQfg8qGX';
  var mapElement = document.getElementById('area-list-map');

  // if element is inside a details element then to make the map render correctly we open the details element
  // and set up the map before closing the details map after
  grandparent = mapElement.parentElement.parentElement;
  if (grandparent.className.split(/\s+/).indexOf('govuk-details') > -1) {
    details = grandparent;
    details.open = true;
  }

  mapElement.style.height = Math.max(320, window.innerHeight - mapElement.offsetTop - 100) + 'px';

  var mymap = L.map(
    'area-list-map',
    {
      scrollWheelZoom: false,
      attributionControl: false
    }
  )

  var gl = L.mapboxGL({
          style: serviceUrl + '/resources/styles?key=' + apiKey,
          transformRequest: url => {
              return {
                  url: url += '&srs=3857'
              }
          }
      }).addTo(mymap);

  var polygonGroup = L.featureGroup(polygons).addTo(mymap);
  mymap.fitBounds(
    polygonGroup.getBounds(),
    {padding: [1, 1]}
  );

  // if element is inside a details element then close the details element
  if (details) {
    details.open = false;
  }

</script>
